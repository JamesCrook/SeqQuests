<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Sequence Stats</title>
    <link rel="icon" href="./wheel.ico">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" type="text/css" href="./lcars.css">
    <script src="./lcars.js"></script>
  </head>
  <body class="app-root">
    <div class="panel-tight">
    <div class="panel-header">
        <div class="panel-title">Protein Sequence Statistics</div>
    </div>
    <div class="demo-padding">
    <p>This html UI is a demo of how web_server.py can provide streamed data, in this case the stream of found links between proteins (a 4GB+ file). This program may later be elaborated to show more statistics about these links such as a graph of the distribution of scores at different levels.</p>
    <br>
    <button id="startBtn" onclick="startProcessing()">
      Start Processing
    </button>
    <div id="status">
    </div>
    <div class="progress-bar progress-bar-container">
        <div class="progress-fill" id="progressFill">
        </div>
    </div>
    <div class="stats-bar stats-bar-wrap">
      <div class="stat-item">
        <span class="stat-label">Total Records:</span>
        <span class="stat-value" id="totalRecords">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Avg Column 1:</span>
        <span class="stat-value" id="sumCol1">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Avg Column 2:</span>
        <span class="stat-value" id="sumCol2">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Avg Column 3:</span>
        <span class="stat-value" id="sumCol3">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Processing Rate:</span>
        <span class="stat-value" id="rate">0 records/sec</span>
      </div>
    </div>
    </div>
    </div>
    <script src="./stream.js"></script>
    <script>
        let startTime;
        
        function updateUI(stats) {
            document.getElementById('totalRecords').textContent = stats.totalRecords.toLocaleString();
            let t=stats.totalRecords 
            document.getElementById('sumCol1').textContent = (stats.sumCol1/t).toLocaleString();
            document.getElementById('sumCol2').textContent = (stats.sumCol2/t).toLocaleString();
            document.getElementById('sumCol3').textContent = (stats.sumCol3/t).toLocaleString();
            
            // Calculate processing rate
            if (startTime) {
                const elapsed = (Date.now() - startTime) / 1000; // seconds
                const rate = Math.round(stats.totalRecords / elapsed);
                document.getElementById('rate').textContent = rate.toLocaleString() + ' records/sec';
            }
            
            // Update progress bar (you can adjust this based on expected file size)
            const progressPercent = Math.min((stats.totalRecords / 170533) * 100, 100);
            document.getElementById('progressFill').style.width = progressPercent + '%';
            document.getElementById('progressFill').textContent = progressPercent > 5 ? Math.round(progressPercent) + '%' : '';
        }
        
        function setStatus(message, type) {
            
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status bar-' + type;
        }
        
        async function startProcessing() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            
            startTime = Date.now();
            setStatus('Processing data stream...', 'loading');
            
            try {
                const finalStats = await processStreamedData();
                setStatus('Processing complete!', 'complete');
                updateUI(finalStats);
                btn.disabled = false;
            } catch (error) {
                setStatus('Error: ' + error.message, 'error');
                console.error('Processing error:', error);
                btn.disabled = false;
            }
        }
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
          const helpConfig = null;
          new LcarsHeader("Streaming Data", helpConfig);
        })        
    </script>
  </body>
</html>
