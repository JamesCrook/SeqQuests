<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequence Alignment Demo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="lcars.css">
    <link rel="icon" href="./wheel.ico">
    <script src="./sw_support.js"></script>
    <script src="./lcars.js"></script>
    <script src="./vector2d.js"></script>
    <script src="./help.js"></script>
    <style>
    .demo-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 100px);
        }
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .result-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        textarea {
            width: 100%;
            height: 100px;
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-accent-primary);
            padding: 10px;
            font-family: var(--font-mono);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .benchmark {
            font-family: var(--font-mono);
            color: var(--color-accent-secondary);
            font-size: 0.8rem;
        }
    </style>
  </head>
  <body class="app-root">
    <div class="container explorer-layout">
      <div class="panel-tight flex-fill">
        <div class="panel-header">
          <span class="panel-title">Sequence Input</span>
        </div>
        <div class="flex-col flex-fill scroll-y">
          <div class="demo-padding">
            <div class="input-area">
              <label class="sequence-label">Sequence 1</label>
              <textarea id="seq1">
                MKLLVILLFSALALAAQKPGGAPTTSLIGNESRSDQPSTVAAA
              </textarea>
              <label class="sequence-label">Sequence 2</label>
              <textarea id="seq2">MVTAQKPGGAPTTQLLGNESRSDQPSTVGGG</textarea>
            </div>
            <div class="controls" style="margin-top: 20px;">
              <button id="alignServerBtn" onclick="runAlign('server')">
                Align on Server (API)
              </button>
              <button id="alignJsBtn" onclick="runAlign('js')">
                Align Client (JS)
              </button>
              <button id="alignWasmBtn" onclick="runAlign('wasm')">
                Align Client (WASM)
              </button>
            </div>
            <div id="perfResult" class="benchmark">
            </div>
          </div>
          <div class="panel-header">
            <span class="panel-title">Alignment Result</span>
          </div>
          <div class="demo-padding">
            <div id="alignmentViewer" class="alignment-viewer-container">
              <div class="empty-state">
                <span>No alignment generated</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
    // Initialize WASM on load
        initWasm().then(success => {
            if (success) {
                document.getElementById('statusText').textContent += " + WASM Ready";
            } else {
                document.getElementById('statusText').textContent += " (WASM Unavailable)";
            }
        });


        function renderResult(alignment, viewer) {

            if (!alignment) {
                viewer.innerHTML = '<div class="empty-state">No alignment found</div>';
                return;
            }

            const lines = formatAlignment( alignment );

            viewer.innerHTML = `
                <div style="margin-bottom: 10px; color: var(--color-accent-primary);">
                    Score: ${alignment.score.toFixed(1)} | Identity: ${calculateIdentity(alignment)}%
                </div>
                <pre style="margin: 0; color: var(--text-primary);">${lines.join('\n')}</pre>
            `;
        }        

        async function runAlign(mode) {
            const seq1 = document.getElementById('seq1').value.trim();
            const seq2 = document.getElementById('seq2').value.trim();
            const viewer = document.getElementById('alignmentViewer');
            const perfDiv = document.getElementById('perfResult');

            viewer.innerHTML = '<div class="loading"></div> Computing...';
            perfDiv.textContent = '';

            const start = performance.now();
            let result = null;
            let method = '';

            try {
                if (mode === 'server') {
                    method = 'Server API';

                    if (seq1.length < 20 && !seq1.includes(' ')) {
                         // Assume ID
                         const response = await fetch(`/api/comparison/${seq1}/${seq2}`);
                         if (!response.ok) throw new Error("Server error");
                         result = await response.json();
                    } else {
                        throw new Error("Server endpoint requires Sequence IDs (e.g. 'P12345'), but raw sequence detected. Use Client mode.");
                    }

                } else if (mode === 'js') {
                    method = 'Client JS';
                    // Allow UI to update
                    await new Promise(r => setTimeout(r, 10));
                    result = alignLocalJS(seq1, seq2);

                } else if (mode === 'wasm') {
                    method = 'Client WASM';
                    if (!wasmExports) {
                        throw new Error("WASM not loaded. Please compile sw_align.wasm.");
                    }
                    result = runWasmAlign(seq1, seq2);
                }

                const end = performance.now();
                const time = (end - start).toFixed(2);
                perfDiv.textContent = `${method} completed in ${time} ms`;

                renderResult(result, viewer);

            } catch (e) {
                viewer.innerHTML = `<div class="status error">Error: ${e.message}</div>`;
                perfDiv.textContent = 'Failed';
            }
        }


        // Init connection check
        fetch('/api/jobs').then(() => {
            const dot = document.getElementById('statusDot');
            dot.classList.remove('disconnected');
            dot.classList.add('connected');
        }).catch(() => {});

        window.addEventListener('DOMContentLoaded', () => {

            const helpConfig = [
                {
                    items: [
                        {
                            text: '<strong>Align Sequences:</strong><br>This page is a test page to check the code that makes alignments.',
                            targetId: 'page-title',
                            type: 'results'
                        },                    
                        {
                            text: '<strong>Menu:</strong><br>Click to get a menu of choices - such as other web pages to visit.',
                            targetId: 'hamburger-menu',
                            type: 'default'
                        },
                        {
                            text: '<strong>Status:</strong><br><ul style="padding-left:15px;"><li><em>Red</em> if no response from lab server</li><li><em>Light Blue</em> if has a response from the lab server</li></ul>',
                            targetId: 'statusDot',
                            type: 'results'
                        }
                    ]
                },
                {
                    items: [
                        { text: '<strong>Sequence 1:</strong><br>Enter the first protein sequence.', targetId: 'seq1' },
                        { text: '<strong>Sequence 2:</strong><br>Enter the second protein sequence.', targetId: 'seq2' },
                        {
                            text: '<strong>Align on server:</strong><br>The sequence alignment is requested from the lab server.',
                            targetId: 'alignServerBtn',
                            type: 'default'
                        },
                        {
                            text: '<strong>Align using Javascript:</strong><br>A slower implementation for aligning two sequences that works on nearly all browsers.',
                            targetId: 'alignJsBtn',
                            type: 'default'
                        },
                        {
                            text: '<strong>Align using WASM:</strong><br>An accelerated implementation of sequence alignment that only works on browsers that support WASM.',
                            targetId: 'alignWasmBtn',
                            type: 'default'
                        },
                        {
                            text: '<strong>Result:</strong><br>This is where the alignment result is shown.',
                            targetId: 'alignmentViewer',
                            type: 'results'
                        }
                    ]
                }
            ];            
            new LcarsHeader("Align Sequences", helpConfig);
        })
    </script>
  </body>
</html>
