<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Sequence Match Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #2d2d44;
            --accent-primary: #ff9966;
            --accent-secondary: #cc99ff;
            --accent-tertiary: #ffcc99;
            --accent-alert: #ff6666;
            --accent-success: #99ccff;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
            --border-color: #ff9966;
            --panel-border: 3px;
            --hover-bg: rgba(255, 153, 102, 0.1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Decorative corner elements */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, transparent 70%);
            opacity: 0.1;
            pointer-events: none;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: linear-gradient(-135deg, var(--accent-secondary) 0%, transparent 70%);
            opacity: 0.1;
            pointer-events: none;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: minmax(400px, 1fr) 640px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: calc(100vh - 100px);
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-bottom: var(--panel-border) solid var(--accent-primary);
            padding: 15px 30px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-family: 'Work Sans', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-alert);
            transition: background 0.3s ease;
        }

        .status-dot.connected {
            background: var(--accent-success);
            animation: blink 2s ease-in-out infinite;
        }

        .status-dot.disconnected {
            background: var(--accent-alert);
            animation: none;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .panel {
            background: var(--bg-secondary);
            border: var(--panel-border) solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-top: 80px;
        }

        .alignment-panel {
            grid-column: 1 / -1;
            margin-top: 80px;
            height: 280px;
            min-height: 280px;
            max-height: 280px;
        }

        .findings-panel {
            grid-column: 1;
            grid-row: 2;
            margin-top: 0;
        }

        .detail-panel-container {
            grid-column: 2;
            grid-row: 2;
            margin-top: 0;
        }

        .panel-header {
            padding: 15px 24px;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-primary);
        }

        .panel-badge {
            background: rgba(255, 153, 102, 0.2);
            color: var(--accent-primary);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--accent-primary);
        }

        .copy-button {
            background: rgba(255, 153, 102, 0.2);
            color: var(--accent-primary);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'Work Sans', sans-serif;
            border: 1px solid var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .copy-button:hover {
            background: rgba(255, 153, 102, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 153, 102, 0.3);
        }

        .copy-button:active {
            transform: translateY(0);
        }

        .copy-button.copied {
            background: rgba(153, 204, 255, 0.2);
            color: var(--accent-success);
            border-color: var(--accent-success);
        }

        .findings-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .findings-list::-webkit-scrollbar {
            width: 10px;
        }

        .findings-list::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .findings-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        .findings-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-tertiary);
        }

        .finding-entry {
            margin-bottom: 20px;
            padding: 14px 16px;
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border-left: 4px solid transparent;
            background: rgba(255, 153, 102, 0.05);
        }

        .finding-entry:hover {
            background: var(--hover-bg);
            border-left-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .finding-entry.active {
            background: rgba(255, 153, 102, 0.2);
            border-left-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(255, 153, 102, 0.3);
        }

        .finding-header {
            color: var(--accent-tertiary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .finding-detail {
            color: var(--text-secondary);
            padding-left: 8px;
            transition: color 0.2s;
        }

        .finding-entry:hover .finding-detail {
            color: var(--text-primary);
        }

        .detail-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sequence-viewer {
            flex: 1;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 24px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.6;
            max-width: 100%;
        }

        .sequence-viewer::-webkit-scrollbar {
            width: 10px;
        }

        .sequence-viewer::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .sequence-viewer::-webkit-scrollbar-thumb {
            background: var(--accent-secondary);
            border-radius: 10px;
        }

        .sequence-viewer::-webkit-scrollbar-thumb:hover {
            background: var(--accent-tertiary);
        }

        .alignment-viewer-container {
            flex: 1;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            overflow: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
        }

        .alignment-viewer-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .alignment-viewer-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .alignment-viewer-container::-webkit-scrollbar-thumb {
            background: var(--accent-tertiary);
            border-radius: 10px;
        }

        .sequence-section {
            margin-bottom: 28px;
            opacity: 0;
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .sequence-section:nth-child(2) {
            animation-delay: 0.1s;
        }

        .sequence-section:nth-child(3) {
            animation-delay: 0.2s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sequence-label {
            color: var(--accent-secondary);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
        }

        .sequence-label::before {
            content: '';
            width: 3px;
            height: 14px;
            background: var(--accent-secondary);
            border-radius: 2px;
        }

        .sequence-text {
            color: var(--text-primary);
            word-break: break-all;
            padding: 1px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border-left: 3px solid var(--accent-primary);
            white-space: pre-wrap;
            width: 84ch;
        }

        .alignment-viewer {
            color: var(--text-primary);
            white-space: pre;
            overflow-x: auto;
        }

        .alignment-viewer::-webkit-scrollbar {
            height: 8px;
        }

        .alignment-viewer::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .alignment-viewer::-webkit-scrollbar-thumb {
            background: var(--accent-tertiary);
            border-radius: 4px;
        }

        /* Amino acid coloring */
        .aa-match { color: var(--accent-primary); font-weight: 600; }
        .aa-mismatch { color: var(--text-muted); }
        .aa-gap { color: var(--accent-secondary); }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent-primary);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: rgba(255, 153, 102, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 153, 102, 0.3);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <header>
        <h1>Protein Sequence Match Explorer</h1>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Checking Connection</span>
        </div>
    </header>

    <div class="container">
        <!-- Top Panel: Alignment View -->
        <div class="panel alignment-panel">
            <div class="panel-header">
                <div class="panel-title">Alignment Visualization</div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="copy-button" id="copyAlignmentBtn" onclick="copyAlignment()">Copy Alignment</button>
                    <div class="panel-badge" id="alignmentBadge">—</div>
                </div>
            </div>
            <div class="alignment-viewer-container" id="alignmentViewer">
                <div class="empty-state">
                    <div class="empty-state-icon">╳</div>
                    <div class="empty-state-text">No alignment selected</div>
                    <div class="empty-state-subtext">Hover over an entry to view alignment</div>
                </div>
            </div>
        </div>

        <!-- Left Panel: Findings List -->
        <div class="panel findings-panel">
            <div class="panel-header">
                <div class="panel-title">Protein Alignments</div>
                <div class="panel-badge" id="entriesCount">14 entries</div>
            </div>
            <div class="findings-list" id="findingsList">
                <!-- Findings will be populated here -->
            </div>
        </div>

        <!-- Right Panel: Detail View -->
        <div class="panel detail-panel-container">
            <div class="panel-header">
                <div class="panel-title">Sequence Details</div>
                <div class="panel-badge" id="detailBadge">—</div>
            </div>
            <div class="sequence-viewer" id="detailViewer">
                <div class="empty-state">
                    <div class="empty-state-icon">◯</div>
                    <div class="empty-state-text">Select an alignment to view details</div>
                    <div class="empty-state-subtext">Hover over entries in the left panel to explore sequence data</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin; // Will use same origin as page
        const API_TIMEOUT = 5300; // milliseconds
        let isServerConnected = false;
        let usingRealFindings = false; // Track if we loaded real findings from server

        // Connection status management
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        function setConnectionStatus(connected) {
            if (connected) {
                statusDot.classList.add('connected');
                statusDot.classList.remove('disconnected');
                statusText.textContent = 'Server Connected';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                statusText.textContent = 'Using Mock Data';
            }
        }

        // Fetch findings list from server with timeout
        async function fetchFindingsList() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
                
                const response = await fetch(`${API_BASE_URL}/api/findings`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    return await response.text();
                }
                return null;
            } catch (error) {
                // Silently fail and fall back to mock data
                return null;
            }
        }

        // Fetch sequence details from server with timeout
        async function fetchSequenceDetails(id1, id2) {
            // Only fetch from server if we're using real findings data
            if (!usingRealFindings) {
                return null;
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
                
                const response = await fetch(`${API_BASE_URL}/api/comparison/${id1}/${id2}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                // Silently fail and fall back to mock data
                return null;
            }
        }

        // Mock data based on the provided document
        const findingsData = `249655-33536 s(299) Q1Q8Y4-Q8LEM4 Length: 95/122 [...skipped 1 similar names]
 249655: Cell division topological specificity factor {ECO:0000255|HAMAP-Rule:MF_00262}; Psychrobacter cryohalolentis (strain ATCC BAA-1226 / DSM 17306 / VKM B-2378 / K5).
 33536: Autophagy-related protein 8a; Arabidopsis thaliana (Mouse-ear cress).
80774-148481 s(299) Q9KM66-P48027 Length: 686/907
 80774: CAI-1 autoinducer sensor kinase/phosphatase CqsS; Vibrio cholerae serotype O1 (strain ATCC 39315 / El Tor Inaba N16961).
 148481: Sensor protein GacS; Pseudomonas syringae pv. syringae.
249652-243170 s(299) Q3ICG2-Q5PN73 Length: 88/320
 249652: Cell division topological specificity factor {ECO:0000255|HAMAP-Rule:MF_00262}; Pseudoalteromonas translucida (strain TAC 125).
 243170: o-succinylbenzoate synthase {ECO:0000255|HAMAP-Rule:MF_00470}; Salmonella paratyphi A (strain ATCC 9150 / SARB42).
135066-235941 s(299) P13386-Q96JQ5 Length: 243/239
 135066: High affinity immunoglobulin epsilon receptor subunit beta; Rattus norvegicus (Rat).
 235941: Membrane-spanning 4-domains subfamily A member 4A; Homo sapiens (Human).
14243-62325 s(299) O60022-P81702 Length: 152/134 [...skipped 4 similar names]
 14243: Allergen Asp f 15; Aspergillus fumigatus (strain ATCC MYA-4609 / CBS 101355 / FGSC A1100 / Af293) (Neosartorya fumigata).
 62325: Cerato-platanin {ECO:0000303|PubMed:10455173, ECO:0000303|PubMed:15063505, ECO:0000303|PubMed:33736287, ECO:0000312|EMBL:CAC84090.2}; Ceratocystis fimbriata f. sp. platani.
229673-224520 s(299) Q5PH64-Q2GA52 Length: 78/263 [...skipped 12 similar names]
 229673: Major outer membrane lipoprotein Lpp 1 {ECO:0000255|HAMAP-Rule:MF_00843}; Salmonella paratyphi A (strain ATCC 9150 / SARB42).
 224520: Leucyl/phenylalanyl-tRNA--protein transferase {ECO:0000255|HAMAP-Rule:MF_00688}; Novosphingobium aromaticivorans (strain ATCC 700278 / DSM 12444 / CCUG 56034 / CIP 105152 / NBRC 16084 / F199).
191425-164415 s(299) Q9XER9-Q9FPQ6 Length: 1392/555
 191425: ENHANCER OF AG-4 protein 2; Arabidopsis thaliana (Mouse-ear cress).
 164415: Vegetative cell wall protein gp1; Chlamydomonas reinhardtii (Chlamydomonas smithii).
111107-104529 s(299) P0DXU8-P40764 Length: 253/332 [...skipped 1 toxins and 8 similar names]
 111107: Daunorubicin resistance ABC transporter permease protein DrrB3 {ECO:0000305}; Streptomyces coeruleorubidus.
 104529: Homeobox protein DLX-2; Mus musculus (Mouse).
253920-122547 s(299) M0R6D8-P18488 Length: 403/497 [...skipped 6 similar names]
 253920: Motor neuron and pancreas homeobox 1 {ECO:0000312|RGD:1588091}; Rattus norvegicus (Rat).
 122547: Homeotic protein empty spiracles; Drosophila melanogaster (Fruit fly).
155588-48625 s(299) C3RT17-E7EKH2 Length: 70/71 [...skipped 1 similar names]
 155588: Gaegurin-LK1 {ECO:0000303|PubMed:23054029}; Limnonectes kuhlii (Kuhl's Creek frog) (Rana kuhlii).
 48625: Brevinin-1SN2 {ECO:0000303|PubMed:24055160}; Sylvirana spinulosa (Fine-spined frog) (Hylarana spinulosa).
155210-155218 s(299) Q6GKV1-A1Z3X3 Length: 324/323 [...skipped 1 uncharacterized]
 155210: Protein GET4 {ECO:0000303|PubMed:28096354}; Arabidopsis thaliana (Mouse-ear cress).
 155218: Golgi to ER traffic protein 4 homolog; Oryzias latipes (Japanese rice fish) (Japanese killifish).
194429-57527 s(299) Q9LSS5-Q8C9S4 Length: 564/917 [...skipped 1 similar names]
 194429: Interactor of constitutive active ROPs 3; Arabidopsis thaliana (Mouse-ear cress).
 57527: Coiled-coil domain-containing protein 186; Mus musculus (Mouse).
42840-32796 s(299) Q9JLV1-P37278 Length: 577/926 [...skipped 1 uncharacterized and 4 similar names]
 42840: BAG family molecular chaperone regulator 3; Mus musculus (Mouse).
 32796: Calcium-transporting ATPase; Synechococcus elongatus (strain ATCC 33912 / PCC 7942 / FACHB-805) (Anacystis nidulans R2).
278355-85204 s(298) Q8R4I7-Q9JLB4 Length: 533/3623 [...skipped 1 similar names]
 278355: Neuropilin and tolloid-like protein 1; Mus musculus (Mouse).
 85204: Cubilin; Mus musculus (Mouse).
55228-168022 s(298) B1NY81-P10496 Length: 312/465 [...skipped 1 similar names]
 55228: Dehydrin CAS31 {ECO:0000305}; Medicago truncatula (Barrel medic) (Medicago tribuloides).
 168022: Glycine-rich cell wall structural protein 1.8; Phaseolus vulgaris (Kidney bean) (French bean).`;

        // Mock sequence data generator
        function generateMockSequence(length) {
            const aminoAcids = 'ACDEFGHIKLMNPQRSTVWY';
            let sequence = '';
            for (let i = 0; i < length; i++) {
                sequence += aminoAcids[Math.floor(Math.random() * aminoAcids.length)];
            }
            return sequence;
        }

        function generateMockAlignment(seq1, seq2) {
            const maxLen = Math.max(seq1.length, seq2.length);
            let align1 = '';
            let align2 = '';
            let matches = '';
            
            for (let i = 0; i < maxLen; i++) {
                const aa1 = seq1[i] || '-';
                const aa2 = seq2[i] || '-';
                align1 += aa1;
                align2 += aa2;
                
                if (aa1 === aa2 && aa1 !== '-') {
                    matches += '|';
                } else if (aa1 === '-' || aa2 === '-') {
                    matches += ' ';
                } else {
                    matches += ':';
                }
            }
            
            return { align1, align2, matches };
        }

        function formatSequenceWithLineNumbers(sequence, lineLength = 70) {
            let formatted = '';
            for (let i = 0; i < sequence.length; i += lineLength) {
                const lineNum = String(i + 1).padStart(6, ' ');
                const chunk = sequence.substr(i, lineLength);
                formatted += `${lineNum}  ${chunk}\n`;
            }
            return formatted;
        }

        // Parse findings data
        function parseFindings(data) {
            const lines = data.trim().split('\n');
            const findings = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.match(/^\d+-\d+/)) {
                    const header = line;
                    const details = [];
                    
                    // Collect detail lines
                    while (i + 1 < lines.length && lines[i + 1].startsWith(' ')) {
                        details.push(lines[i + 1]);
                        i++;
                    }
                    
                    findings.push({ header, details });
                }
            }
            
            return findings;
        }

        const findings = parseFindings(findingsData);
        let currentHoveredEntry = null;
        let isInitializing = false;
        let isLoadingSequence = false;
        let lastLoadedEntry = null;

        // Initialize the application
        async function initializeApp() {
            // Prevent multiple simultaneous initializations
            if (isInitializing) {
                return;
            }
            isInitializing = true;

            // Try to fetch findings from server (includes health check)
            const serverFindings = await fetchFindingsList();
            const bFound = serverFindings ? true:false;

            isServerConnected = bFound;
            usingRealFindings = bFound;
            setConnectionStatus(bFound);
            
            const dataToUse = serverFindings || findingsData;
            const parsedFindings = parseFindings(dataToUse);

            // Update entry count
            document.getElementById('entriesCount').textContent = `${parsedFindings.length} entries`;

            // Populate findings list
            populateFindingsList(parsedFindings);
            
            isInitializing = false;
        }

        // Populate findings list
        function populateFindingsList(findingsArray) {
            const findingsList = document.getElementById('findingsList');
            findingsList.innerHTML = '';
            
            findingsArray.forEach((finding, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'finding-entry';
                entryDiv.dataset.index = index;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'finding-header';
                headerDiv.textContent = finding.header;
                
                entryDiv.appendChild(headerDiv);
                
                finding.details.forEach(detail => {
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'finding-detail';
                    detailDiv.textContent = detail;
                    entryDiv.appendChild(detailDiv);
                });
                
                // Hover event
                entryDiv.addEventListener('mouseenter', async () => {
                    // Ignore if already loading or if this is the same entry we just loaded
                    if (isLoadingSequence || lastLoadedEntry === index) {
                        return;
                    }
                    
                    // Remove active class from all entries
                    document.querySelectorAll('.finding-entry').forEach(e => e.classList.remove('active'));
                    entryDiv.classList.add('active');
                    
                    currentHoveredEntry = index;
                    await loadSequenceDetails(finding, index);
                });
                
                findingsList.appendChild(entryDiv);
            });
        }

        async function loadSequenceDetails(finding, index) {
            // Set loading flag
            isLoadingSequence = true;
            
            const detailViewer = document.getElementById('detailViewer');
            const alignmentViewer = document.getElementById('alignmentViewer');
            const detailBadge = document.getElementById('detailBadge');
            const alignmentBadge = document.getElementById('alignmentBadge');
            
            // Show loading state
            detailViewer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; gap: 12px;"><div class="loading"></div><span>Loading sequence data...</span></div>';
            alignmentViewer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; gap: 12px;"><div class="loading"></div><span>Loading alignment...</span></div>';
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Check if still hovering the same entry
            if (currentHoveredEntry !== index) {
                isLoadingSequence = false;
                return;
            }
            
            // Extract IDs and lengths from header
            const headerMatch = finding.header.match(/(\d+)-(\d+).*Length: (\d+)\/(\d+)/);
            if (!headerMatch) {
                isLoadingSequence = false;
                return;
            }
            
            const [, id1, id2, len1, len2] = headerMatch;
            
            // Try to fetch from server first
            let serverData = await fetchSequenceDetails(id1, id2);
            
            let seq1, seq2, alignment, score;
            
            if (serverData) {
                // Use server data
                seq1 = serverData.sequence1;
                seq2 = serverData.sequence2;
                score = serverData.score;
                seq1Details = seq1;
                seq2Details = seq2;
                alignment = {
                    align1: serverData.alignment1,
                    align2: serverData.alignment2,
                    matches: serverData.matches
                };
            } else {
                // Fall back to mock data
                seq1 = generateMockSequence(parseInt(len1));
                seq2 = generateMockSequence(parseInt(len2));
                score = -1;
                seq1Details = formatSequenceWithLineNumbers(seq1);
                seq2Details = formatSequenceWithLineNumbers(seq2);

                alignment = generateMockAlignment(seq1, seq2);
            }
            
            // Calculate stats
            const matches = (alignment.matches.match(/\|/g) || []).length;
            const similarity = score ;//((matches / Math.max(seq1.length, seq2.length)) * 100).toFixed(1);
            
            // Update badges
            detailBadge.textContent = `${similarity}% identity`;
            alignmentBadge.textContent = `${matches} matches`;
            
            // Build alignment view
            const alignLines = [];
            const lineLen = 70;
            for (let i = 0; i < alignment.align1.length; i += lineLen) {
                const pos1 = String(i + 1).padStart(6, ' ');
                const chunk1 = alignment.align1.substr(i, lineLen);
                const chunkMatch = alignment.matches.substr(i, lineLen);
                const chunk2 = alignment.align2.substr(i, lineLen);
                
                alignLines.push(`${pos1}  ${chunk1}`);
                alignLines.push(`        ${chunkMatch}`);
                alignLines.push(`        ${chunk2}\n`);
            }
            
            alignmentViewer.innerHTML = `<pre style="margin: 0; color: var(--text-primary);">${alignLines.join('\n')}</pre>`;
            
            // Build detail view
            detailViewer.innerHTML = `
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-label">Match Score</div>
                        <div class="stat-value">${finding.header.match(/s\((\d+)\)/)[1]}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Identity</div>
                        <div class="stat-value">${similarity}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Length 1</div>
                        <div class="stat-value">${len1}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Length 2</div>
                        <div class="stat-value">${len2}</div>
                    </div>
                </div>
                
                <div class="sequence-section">
                    <div class="sequence-label">Sequence 1 (ID: ${id1})</div>
                    <div class="sequence-text">${seq1Details}</div>
                </div>
                
                <div class="sequence-section">
                    <div class="sequence-label">Sequence 2 (ID: ${id2})</div>
                    <div class="sequence-text">${seq2Details}</div>
                </div>
            `;
            
            // Mark this entry as loaded and clear loading flag
            lastLoadedEntry = index;
            isLoadingSequence = false;
        }

        // Copy alignment to clipboard
        function copyAlignment() {
            const alignmentViewer = document.getElementById('alignmentViewer');
            const copyBtn = document.getElementById('copyAlignmentBtn');
            
            // Get the text content from the pre element
            const preElement = alignmentViewer.querySelector('pre');
            
            if (!preElement || preElement.textContent.includes('No alignment selected') || preElement.textContent.includes('Loading')) {
                return;
            }
            
            const alignmentText = preElement.textContent;
            
            // Copy to clipboard
            navigator.clipboard.writeText(alignmentText).then(() => {
                // Show success feedback
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy alignment:', err);
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
    </script>
</body>
</html>